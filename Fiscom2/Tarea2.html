<head>
    <title>Metodo de Disparo</title>
    <link href="https://fonts.googleapis.com/css?family=Nunito" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        html * {
            font-family: Nunito, sans-serif;
        }

        .w-40 {
            width: 40%;
        }

        .wrapper {
            display: grid;
            grid-template-columns: repeat(2, 50%);
            gap: 10px;
        }

        .hide {
            display: none;
        }

        .bb {
            color: #ffffff;
            background-color: #28559a;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark bb">
        <a href="#" class="mx-3"><img src="logo.png" alt="" width="50"></a>
        <a class="navbar-brand mx-auto fs-2 fw-bold" href="index.html">Método de Disparo: Bisección</a>
    </nav>    
    <div class="m-5">
        <script src="https://cdn.plot.ly/plotly-2.18.0.min.js"></script>
        <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="Lower Bound for E" aria-label="Lower Bound for E"
                id="E-lower">
            <span class="input-group-text">&harr;</span>
            <input type="text" class="form-control" placeholder="Upper Bound for E" aria-label="Upper Bound for E"
                id="E-upper">
            <button class="btn btn-outline-secondary w-25 fs-4" id="par-toggle" onclick="togglePar()">Par</button>
            <button class="btn btn-outline-secondary w-25 fs-4" id="par-toggle" onclick="bisec()">Find Energy</button>
        </div>
        <div id="plot" class="w-75 mx-auto" style="height:70%;"></div>
        <div>
            <p class="fs-5 hide" id="ans-div">
                La energía es de <span id="energy-out"></span> ue.
            </p>
        </div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
<!-- <script src="17-02.js"></script> -->

<script>
    const ELow = document.getElementById('E-lower');
    const EUp = document.getElementById('E-upper');
    const ans = document.getElementById('energy-out');
    const ansDiv = document.getElementById('ans-div');

    const parBtn = document.getElementById('par-toggle');

    class Wave {
        constructor(N, xmax) {
            this.N = N;
            this.xmax = xmax;
            this.x = [...Array(this.N)].map((_, i) => xmax * i / this.N); // "..." is used for unpack
            this.m = 1;
            this.h = 1;
            this.L = 1;
            this.U = function (x) { return x > this.L ? 1e6 : 0 }; // Single line IF
            // this.U = function (x) {return Math.sin(x);}
            this.psi = this.x.map(xi => 0);
            this.dx = this.x[1] - this.x[2];
        }

        update(par, E) {
            if (par == true) {
                this.psi[0] = 1;
                this.psi[1] = 1;
            }
            else {
                this.psi[0] = 0;
                this.psi[1] = this.dx;
            }
            for (let i = 2; i < this.psi.length; i++) {
                this.psi[i] = 2 * this.dx ** 2 * (this.U(this.x[i - 1]) - E) * this.psi[i - 1] + 2 * this.psi[i - 1] - this.psi[i - 2]
            }
            return this.psi[this.psi.length - 1];
        }
    }

    let El, Eu, E;
    let par = true;
    let xmax = 1.2;
    let waveL = new Wave(500, xmax);
    let waveU = new Wave(500, xmax);
    let waveM = new Wave(500, xmax);

    function plot2() {
        waveL.update(par, El);
        waveU.update(par, Eu);

        var lower = {
            x: waveL.x,
            y: waveL.psi,
            type: 'scatter',
            name: 'lower',
            line: { width: 3 }
        };

        var upper = {
            x: waveU.x,
            y: waveU.psi,
            type: 'scatter',
            name: 'upper',
            line: { width: 3 }
        };

        var data = [lower, upper];

        var layout = {
            xaxis: { range: [0, xmax] },
            yaxis: { range: [-1.5, 1.5] }
        };

        Plotly.newPlot('plot', data, layout);
        ansDiv.classList.remove('hide');
    }

    function bisec() {
        El = parseFloat(ELow.value);
        Eu = parseFloat(EUp.value);
        let signL = waveL.update(par, El);
        console.log(signL);

        let signU = waveU.update(par, Eu);
        console.log(signU);

        let tol = 1e-6;
        let dif = 1;

        while (dif > tol) {
            let Emid = (Eu + El) / 2;
            let signM = waveM.update(par, Emid);
            if (signL * signM > 0) {
                El = Emid;
            } else {
                Eu = Emid;
            }
            dif = Math.abs(Eu - El);
            console.log(dif);
        }

        plot2();
        ans.innerText = ((Eu + El) / 2).toPrecision(6);
    }

    function togglePar() {
        par = !par;
        if (par == true) {
            parBtn.innerText = 'Par';
        } else {
            parBtn.innerText = 'Impar';
        }
    }
</script>